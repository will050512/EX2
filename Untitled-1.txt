/**
 * è‹±èªå­¸ç¿’å¹³å°å¾Œç«¯ Apps Script
 * è™•ç†è©¦ç”¨ç”¨æˆ¶è¨»å†Šã€é‡è¤‡æª¢æŸ¥å’Œæ•¸æ“šç®¡ç†
 */

// é…ç½®è¨­å®š
const CONFIG = {
  SPREADSHEET_ID: '1E8VLVMpBhC_fVW43xr_8r9CDt7cG_7sPpZfk6vZpVXc', // è«‹æ›¿æ›ç‚ºæ‚¨çš„è©¦ç®—è¡¨ID
  SHEET_NAME: 'ç”¨æˆ¶è³‡æ–™',
  NOTIFICATION_EMAIL: 'info.aifunschool@gmail.com', // æ¥æ”¶é€šçŸ¥çš„éƒµç®±
  MAX_DAILY_TRIALS: 1000, // æ¯æ—¥æœ€å¤§è©¦ç”¨æ•¸é‡é™åˆ¶
};

/**
 * ä¸»è¦å…¥å£å‡½æ•¸ - è™•ç†æ‰€æœ‰HTTPè«‹æ±‚
 */
function doPost(e) {
  try {
    // è¨­ç½®CORSæ¨™é ­
    const response = {
      headers: {
        'Access-Control-Allow-Origin': '*',
        'Access-Control-Allow-Methods': 'POST, GET, OPTIONS',
        'Access-Control-Allow-Headers': 'Content-Type',
        'Content-Type': 'application/json'
      }
    };

    // è§£æè«‹æ±‚åƒæ•¸
    const params = parseRequestParams(e);
    const action = params.action;

    console.log('æ”¶åˆ°è«‹æ±‚:', action, params);

    // æ ¹æ“šactionåˆ†ç™¼è™•ç†
    let result;
    switch (action) {
      case 'checkDuplicate':
        result = handleCheckDuplicate(params);
        break;
      case 'submitTrial':
        result = handleSubmitTrial(params);
        break;
      case 'getStats':
        result = handleGetStats(params);
        break;
      default:
        result = { error: true, message: 'ç„¡æ•ˆçš„è«‹æ±‚é¡å‹' };
    }

    return ContentService
      .createTextOutput(JSON.stringify(result))
      .setMimeType(ContentService.MimeType.JSON);

  } catch (error) {
    console.error('è™•ç†è«‹æ±‚æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
    return ContentService
      .createTextOutput(JSON.stringify({
        error: true,
        message: 'ä¼ºæœå™¨å…§éƒ¨éŒ¯èª¤',
        details: error.toString()
      }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

/**
 * è™•ç†OPTIONSè«‹æ±‚ï¼ˆCORSé æª¢ï¼‰
 */
function doOptions(e) {
  // ç°¡åŒ– OPTIONS å›æ‡‰ï¼šApps Script ç„¡æ³•å¯é åœ°è¨­ç½®è‡ªå®šç¾©å›æ‡‰æ¨™é ­æ–¼ TextOutputï¼Œ
  // åªå›å‚³ç©ºçš„æ–‡å­—å›è¦†å³å¯è®“ç€è¦½å™¨å®Œæˆé æª¢ï¼ˆå¯¦å‹™ä¸Šä¹Ÿè«‹ç¢ºä¿ Web App éƒ¨ç½²ç‚ºã€Œä»»ä½•äººï¼ˆåŒ¿åï¼‰ã€ï¼‰ã€‚
  return ContentService
    .createTextOutput('')
    .setMimeType(ContentService.MimeType.TEXT);
}

/**
 * è§£æè«‹æ±‚åƒæ•¸
 */
function parseRequestParams(e) {
  let params = {};
  
  try {
    // å˜—è©¦è§£æPOST body
    if (e.postData && e.postData.contents) {
      const contentType = e.postData.type || '';
      
      // æ”¯æ´å¸¶æœ‰ charset çš„ content-typeï¼Œä¾‹å¦‚: application/x-www-form-urlencoded;charset=UTF-8
      if (contentType.indexOf('application/x-www-form-urlencoded') !== -1) {
        // è§£æè¡¨å–®æ•¸æ“š (æ³¨æ„ + ä»£è¡¨ç©ºæ ¼)
        const formData = e.postData.contents;
        const pairs = formData.split('&');
        
        pairs.forEach(pair => {
          const [rawKey, rawVal] = pair.split('=');
          const key = decodeURIComponent(rawKey || '');
          const value = decodeURIComponent((rawVal || '').replace(/\+/g, ' '));
          params[key] = value;
        });
      } else if (contentType.indexOf('application/json') !== -1) {
        // è§£æJSONæ•¸æ“šï¼ˆæ”¯æ´åŒ…å« charset çš„æƒ…æ³ï¼‰
        try {
          params = JSON.parse(e.postData.contents);
        } catch (jsonErr) {
          console.error('è§£æ JSON å¤±æ•—:', jsonErr);
        }
      }
    }
    
    // åˆä½µURLåƒæ•¸ï¼ˆquery string / e.parameterï¼‰
    if (e.parameter) {
      params = { ...params, ...e.parameter };
    }
    
  } catch (error) {
    console.error('è§£æè«‹æ±‚åƒæ•¸å¤±æ•—:', error);
  }
  
  return params;
}

/**
 * è™•ç†é‡è¤‡æª¢æŸ¥è«‹æ±‚
 */
function handleCheckDuplicate(params) {
  try {
    const { parentName, phone, email } = params;
    
    // åƒæ•¸é©—è­‰
    if (!parentName || !phone || !email) {
      return {
        error: true,
        message: 'ç¼ºå°‘å¿…è¦åƒæ•¸ï¼šparentName, phone, email'
      };
    }

    // ç²å–è©¦ç®—è¡¨
    const sheet = getOrCreateSheet();
    const data = sheet.getDataRange().getValues();
    const headers = data[0];
    
    // æ‰¾åˆ°å°æ‡‰çš„æ¬„ä½ç´¢å¼•
    const nameIndex = headers.indexOf('å®¶é•·å§“å');
    const phoneIndex = headers.indexOf('è¯çµ¡é›»è©±');
    const emailIndex = headers.indexOf('Email');
    
    if (nameIndex === -1 || phoneIndex === -1 || emailIndex === -1) {
      console.error('è©¦ç®—è¡¨æ ¼å¼éŒ¯èª¤ï¼Œç¼ºå°‘å¿…è¦æ¬„ä½');
      return { error: true, message: 'ç³»çµ±é…ç½®éŒ¯èª¤' };
    }

    // æª¢æŸ¥é‡è¤‡
    for (let i = 1; i < data.length; i++) {
      const row = data[i];
      const rowName = (row[nameIndex] || '').toString().trim();
      const rowPhone = (row[phoneIndex] || '').toString().trim();
      const rowEmail = (row[emailIndex] || '').toString().trim();
      
      // æª¢æŸ¥æ˜¯å¦æœ‰ä»»ä¸€é …ç›®åŒ¹é…
      if (rowName === parentName.trim() || 
          rowPhone === phone.trim() || 
          rowEmail === email.trim()) {
        console.log('ç™¼ç¾é‡è¤‡ç”¨æˆ¶:', { parentName, phone, email });
        return {
          isDuplicate: true,
          message: 'æª¢æ¸¬åˆ°é‡è¤‡è³‡æ–™'
        };
      }
    }

    return { isDuplicate: false };

  } catch (error) {
    console.error('æª¢æŸ¥é‡è¤‡æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
    return {
      error: true,
      message: 'æª¢æŸ¥é‡è¤‡å¤±æ•—',
      details: error.toString()
    };
  }
}

/**
 * è™•ç†è©¦ç”¨æäº¤è«‹æ±‚
 */
function handleSubmitTrial(params) {
  try {
    const {
      parentName,
      phone,
      email,
      childAge,
      ipRegion,
      trialStartTime,
      trialEndTime,
      source
    } = params;

    // åƒæ•¸é©—è­‰
    if (!parentName || !phone || !email) {
      return {
        error: true,
        message: 'ç¼ºå°‘å¿…è¦åƒæ•¸'
      };
    }

    // å†æ¬¡æª¢æŸ¥é‡è¤‡ï¼ˆé›™é‡ä¿éšªï¼‰
    const duplicateCheck = handleCheckDuplicate(params);
    if (duplicateCheck.error) {
      return duplicateCheck;
    }
    if (duplicateCheck.isDuplicate) {
      return {
        isDuplicate: true,
        message: 'æª¢æ¸¬åˆ°é‡è¤‡è³‡æ–™ï¼Œç„¡æ³•é‡è¤‡è¨»å†Š'
      };
    }

    // æª¢æŸ¥æ¯æ—¥è©¦ç”¨é™åˆ¶
    if (!checkDailyLimit()) {
      return {
        error: true,
        message: 'ä»Šæ—¥è©¦ç”¨åé¡å·²æ»¿ï¼Œè«‹æ˜æ—¥å†è©¦'
      };
    }

    // ç²å–è©¦ç®—è¡¨ä¸¦æ·»åŠ æ•¸æ“š
    const sheet = getOrCreateSheet();
    const timestamp = new Date();
    
    // æº–å‚™è¦æ’å…¥çš„æ•¸æ“š
    const rowData = [
      timestamp.toLocaleString('zh-TW'), // è¨»å†Šæ™‚é–“
      parentName.trim(),
      phone.trim(),
      email.trim(),
      childAge || '',
      ipRegion || '',
      trialStartTime || '',
      trialEndTime || '',
      source || 'trial_platform',
      'é€²è¡Œä¸­', // ç‹€æ…‹
      '', // å‚™è¨»
      generateTrialId() // è©¦ç”¨ID
    ];

    // æ’å…¥æ–°è¡Œ
    sheet.appendRow(rowData);
    
    console.log('æˆåŠŸæ·»åŠ è©¦ç”¨ç”¨æˆ¶:', parentName, phone, email);

    // ç™¼é€é€šçŸ¥éƒµä»¶
    try {
      sendNotificationEmail(rowData);
    } catch (emailError) {
      console.error('ç™¼é€é€šçŸ¥éƒµä»¶å¤±æ•—:', emailError);
    }

    return {
      success: true,
      message: 'è©¦ç”¨è¨»å†ŠæˆåŠŸ',
      trialId: rowData[rowData.length - 1]
    };

  } catch (error) {
    console.error('æäº¤è©¦ç”¨æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
    return {
      error: true,
      message: 'æäº¤å¤±æ•—',
      details: error.toString()
    };
  }
}

/**
 * è™•ç†çµ±è¨ˆè«‹æ±‚
 */
function handleGetStats(params) {
  try {
    const sheet = getOrCreateSheet();
    const data = sheet.getDataRange().getValues();
    
    if (data.length <= 1) {
      return {
        totalUsers: 0,
        todayUsers: 0,
        activeTrials: 0
      };
    }

    const today = new Date();
    const todayStr = today.toDateString();
    
    let totalUsers = data.length - 1; // æ‰£é™¤æ¨™é ­è¡Œ
    let todayUsers = 0;
    let activeTrials = 0;
    
    // çµ±è¨ˆæ•¸æ“š
    for (let i = 1; i < data.length; i++) {
      const row = data[i];
      const registrationDate = new Date(row[0]);
      const status = row[9]; // ç‹€æ…‹æ¬„ä½
      
      // ä»Šæ—¥è¨»å†Šæ•¸
      if (registrationDate.toDateString() === todayStr) {
        todayUsers++;
      }
      
      // é€²è¡Œä¸­çš„è©¦ç”¨
      if (status === 'é€²è¡Œä¸­') {
        activeTrials++;
      }
    }

    return {
      totalUsers,
      todayUsers,
      activeTrials,
      lastUpdate: new Date().toLocaleString('zh-TW')
    };

  } catch (error) {
    console.error('ç²å–çµ±è¨ˆæ•¸æ“šæ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
    return {
      error: true,
      message: 'ç²å–çµ±è¨ˆå¤±æ•—',
      details: error.toString()
    };
  }
}

/**
 * ç²å–æˆ–å‰µå»ºè©¦ç®—è¡¨
 */
function getOrCreateSheet() {
  try {
    const spreadsheet = SpreadsheetApp.openById(CONFIG.SPREADSHEET_ID);
    let sheet = spreadsheet.getSheetByName(CONFIG.SHEET_NAME);
    
    if (!sheet) {
      // å‰µå»ºæ–°çš„å·¥ä½œè¡¨
      sheet = spreadsheet.insertSheet(CONFIG.SHEET_NAME);
      
      // è¨­ç½®æ¨™é ­
      const headers = [
        'è¨»å†Šæ™‚é–“',
        'å®¶é•·å§“å',
        'è¯çµ¡é›»è©±',
        'Email',
        'å­©å­å¹´é½¡',
        'IPåœ°å€',
        'è©¦ç”¨é–‹å§‹æ™‚é–“',
        'è©¦ç”¨çµæŸæ™‚é–“',
        'ä¾†æº',
        'ç‹€æ…‹',
        'å‚™è¨»',
        'è©¦ç”¨ID'
      ];
      
      sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
      
      // è¨­ç½®æ ¼å¼
      const headerRange = sheet.getRange(1, 1, 1, headers.length);
      headerRange.setFontWeight('bold');
      headerRange.setBackground('#4285f4');
      headerRange.setFontColor('white');
      
      // è¨­ç½®æ¬„å¯¬
      sheet.setColumnWidth(1, 150); // è¨»å†Šæ™‚é–“
      sheet.setColumnWidth(2, 100); // å®¶é•·å§“å
      sheet.setColumnWidth(3, 120); // è¯çµ¡é›»è©±
      sheet.setColumnWidth(4, 200); // Email
      sheet.setColumnWidth(5, 80);  // å­©å­å¹´é½¡
      sheet.setColumnWidth(6, 120); // IPåœ°å€
      sheet.setColumnWidth(7, 150); // è©¦ç”¨é–‹å§‹
      sheet.setColumnWidth(8, 150); // è©¦ç”¨çµæŸ
      sheet.setColumnWidth(9, 100); // ä¾†æº
      sheet.setColumnWidth(10, 80); // ç‹€æ…‹
      sheet.setColumnWidth(11, 150); // å‚™è¨»
      sheet.setColumnWidth(12, 120); // è©¦ç”¨ID
      
      console.log('æˆåŠŸå‰µå»ºæ–°çš„å·¥ä½œè¡¨:', CONFIG.SHEET_NAME);
    }
    
    return sheet;
    
  } catch (error) {
    console.error('ç²å–è©¦ç®—è¡¨å¤±æ•—:', error);
    throw new Error('ç„¡æ³•å­˜å–è³‡æ–™è¡¨ï¼Œè«‹æª¢æŸ¥è©¦ç®—è¡¨IDè¨­å®š');
  }
}

/**
 * æª¢æŸ¥æ¯æ—¥è©¦ç”¨é™åˆ¶
 */
function checkDailyLimit() {
  try {
    const sheet = getOrCreateSheet();
    const data = sheet.getDataRange().getValues();
    
    if (data.length <= 1) return true;
    
    const today = new Date().toDateString();
    let todayCount = 0;
    
    for (let i = 1; i < data.length; i++) {
      const registrationDate = new Date(data[i][0]);
      if (registrationDate.toDateString() === today) {
        todayCount++;
      }
    }
    
    return todayCount < CONFIG.MAX_DAILY_TRIALS;
    
  } catch (error) {
    console.error('æª¢æŸ¥æ¯æ—¥é™åˆ¶å¤±æ•—:', error);
    return true; // å‡ºéŒ¯æ™‚å…è¨±ç¹¼çºŒ
  }
}

/**
 * ç”Ÿæˆå”¯ä¸€çš„è©¦ç”¨ID
 */
function generateTrialId() {
  const timestamp = Date.now();
  const randomNum = Math.floor(Math.random() * 10000);
  return `TRIAL_${timestamp}_${randomNum}`;
}

/**
 * ç™¼é€é€šçŸ¥éƒµä»¶
 */
function sendNotificationEmail(userData) {
  try {
    if (!CONFIG.NOTIFICATION_EMAIL) return;
    
    const [timestamp, parentName, phone, email, childAge, ipRegion] = userData;
    
    const subject = 'ğŸ¯ æ–°çš„è‹±èªå­¸ç¿’å¹³å°è©¦ç”¨è¨»å†Š';
    const body = `
è¦ªæ„›çš„ç®¡ç†å“¡ï¼Œ

æœ‰æ–°çš„ç”¨æˆ¶è¨»å†Šäº†è‹±èªå­¸ç¿’å¹³å°è©¦ç”¨ï¼š

ğŸ“‹ ç”¨æˆ¶è³‡è¨Šï¼š
â€¢ å®¶é•·å§“åï¼š${parentName}
â€¢ è¯çµ¡é›»è©±ï¼š${phone}
â€¢ Emailï¼š${email}
â€¢ å­©å­å¹´é½¡ï¼š${childAge}
â€¢ IPåœ°å€ï¼š${ipRegion}
â€¢ è¨»å†Šæ™‚é–“ï¼š${timestamp}

è«‹åŠæ™‚è·Ÿé€²ç”¨æˆ¶éœ€æ±‚ã€‚

æ­¤éƒµä»¶ç”±ç³»çµ±è‡ªå‹•ç™¼é€ã€‚
    `;
    
    MailApp.sendEmail({
      to: CONFIG.NOTIFICATION_EMAIL,
      subject: subject,
      body: body
    });
    
    console.log('é€šçŸ¥éƒµä»¶ç™¼é€æˆåŠŸ');
    
  } catch (error) {
    console.error('ç™¼é€é€šçŸ¥éƒµä»¶å¤±æ•—:', error);
  }
}

/**
 * æ¸…ç†éæœŸçš„è©¦ç”¨æ•¸æ“šï¼ˆå¯è¨­å®šç‚ºå®šæ™‚è§¸ç™¼ï¼‰
 */
function cleanupExpiredTrials() {
  try {
    const sheet = getOrCreateSheet();
    const data = sheet.getDataRange().getValues();
    
    if (data.length <= 1) return;
    
    const now = new Date();
    let cleanedCount = 0;
    
    // å¾æœ€å¾Œä¸€è¡Œé–‹å§‹æª¢æŸ¥ï¼ˆé¿å…åˆªé™¤æ™‚ç´¢å¼•è®ŠåŒ–ï¼‰
    for (let i = data.length - 1; i >= 1; i--) {
      const row = data[i];
      const trialEndTimeStr = row[7]; // è©¦ç”¨çµæŸæ™‚é–“
      
      if (trialEndTimeStr) {
        const trialEndTime = new Date(trialEndTimeStr);
        
        // å¦‚æœè©¦ç”¨å·²çµæŸè¶…é7å¤©ï¼Œæ¨™è¨˜ç‚ºéæœŸ
        if (now.getTime() - trialEndTime.getTime() > 7 * 24 * 60 * 60 * 1000) {
          sheet.getRange(i + 1, 10).setValue('å·²éæœŸ'); // æ›´æ–°ç‹€æ…‹
          cleanedCount++;
        }
      }
    }
    
    console.log(`æ¸…ç†ä½œæ¥­å®Œæˆï¼Œæ¨™è¨˜ ${cleanedCount} å€‹éæœŸè©¦ç”¨`);
    return cleanedCount;
    
  } catch (error) {
    console.error('æ¸…ç†éæœŸæ•¸æ“šå¤±æ•—:', error);
    return 0;
  }
}

/**
 * ç²å–è©¦ç®—è¡¨æ•¸æ“šæ‘˜è¦ï¼ˆç®¡ç†ç”¨ï¼‰
 */
function getDataSummary() {
  try {
    const sheet = getOrCreateSheet();
    const data = sheet.getDataRange().getValues();
    
    if (data.length <= 1) {
      return 'è©¦ç®—è¡¨ç‚ºç©º';
    }
    
    const stats = handleGetStats({});
    const recentUsers = [];
    
    // ç²å–æœ€è¿‘5å€‹ç”¨æˆ¶
    for (let i = Math.max(1, data.length - 5); i < data.length; i++) {
      const row = data[i];
      recentUsers.push({
        æ™‚é–“: row[0],
        å§“å: row[1],
        é›»è©±: row[2],
        ç‹€æ…‹: row[9]
      });
    }
    
    return {
      çµ±è¨ˆ: stats,
      æœ€è¿‘ç”¨æˆ¶: recentUsers,
      ç¸½æ•¸æ“šè¡Œæ•¸: data.length - 1
    };
    
  } catch (error) {
    console.error('ç²å–æ•¸æ“šæ‘˜è¦å¤±æ•—:', error);
    return { error: error.toString() };
  }
}

/**
 * æ¸¬è©¦å‡½æ•¸
 */
function testFunctions() {
  console.log('=== é–‹å§‹æ¸¬è©¦ Apps Script åŠŸèƒ½ ===');
  
  // æ¸¬è©¦å‰µå»ºå·¥ä½œè¡¨
  try {
    const sheet = getOrCreateSheet();
    console.log('âœ“ å·¥ä½œè¡¨å‰µå»º/ç²å–æˆåŠŸ');
  } catch (error) {
    console.log('âœ— å·¥ä½œè¡¨æ¸¬è©¦å¤±æ•—:', error);
  }
  
  // æ¸¬è©¦é‡è¤‡æª¢æŸ¥
  try {
    const result = handleCheckDuplicate({
      parentName: 'æ¸¬è©¦ç”¨æˆ¶',
      phone: '0912345678',
      email: 'test@example.com'
    });
    console.log('âœ“ é‡è¤‡æª¢æŸ¥åŠŸèƒ½æ­£å¸¸:', result);
  } catch (error) {
    console.log('âœ— é‡è¤‡æª¢æŸ¥æ¸¬è©¦å¤±æ•—:', error);
  }
  
  // æ¸¬è©¦çµ±è¨ˆåŠŸèƒ½
  try {
    const stats = handleGetStats({});
    console.log('âœ“ çµ±è¨ˆåŠŸèƒ½æ­£å¸¸:', stats);
  } catch (error) {
    console.log('âœ— çµ±è¨ˆåŠŸèƒ½æ¸¬è©¦å¤±æ•—:', error);
  }
  
  console.log('=== æ¸¬è©¦å®Œæˆ ===');
}
