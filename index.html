<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‹±èªå­¸ç¿’å¹³å°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .timer-display {
            background: rgba(255,255,255,0.2);
            padding: 10px 20px;
            border-radius: 20px;
            display: inline-block;
            backdrop-filter: blur(10px);
            margin-bottom: 20px;
        }

        .tabs {
            display: flex;
            background: rgba(255,255,255,0.1);
            border-radius: 15px 15px 0 0;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .tab {
            flex: 1;
            padding: 15px 20px;
            background: transparent;
            border: none;
            color: white;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .tab:hover {
            background: rgba(255,255,255,0.1);
        }

        .tab.active {
            background: rgba(255,255,255,0.2);
            transform: translateY(-2px);
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
        }

    /* æ¨™ç¤ºå¿…å¡«ç‚ºç´…è‰²ä¸¦åŠ ç´…è‰²æ˜Ÿè™Ÿ */
    label.required { color: #c62828; }
    label.required::after { content: ' *'; color: #c62828; margin-left:4px; }

        /* å…¨åŸŸè¨»å†Š overlay èˆ‡è¡¨å–®æ¨£å¼ï¼ˆç¢ºä¿æ¡Œé¢ä¹Ÿæ­£ç¢ºé¡¯ç¤ºï¼‰ */
        .overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.55);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
        }
        .form-card {
            width: 100%;
            max-width: 680px;
            background: #fff;
            padding: 22px;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.25);
            color: #111;
        }
        .form-card h2 { margin: 0 0 8px 0; font-size:18px }
        .form-row { margin-top:12px }
        .form-row label { display:block; font-size:13px; color:#333 }
        .form-row input, .form-row select { width:100%; padding:10px 12px; margin-top:6px; border-radius:8px; border:1px solid #e3e7ea; font-size:14px; box-sizing:border-box }
        .form-actions { margin-top:18px; display:flex; gap:10px; align-items:center }
        .msg { margin-top:12px; padding:10px; border-radius:8px; font-size:14px }
        .msg.error { background:#fff0f0; color:#900; border:1px solid #fcc }
        .msg.success { background:#f0fff6; color:#0a6b2f; border:1px solid #cfeed8 }
        .spinner { display:inline-block; width:16px; height:16px; border-radius:50%; border:2px solid rgba(0,0,0,0.12); border-top-color:#fff; animation:spin 1s linear infinite; margin-left:8px; vertical-align:middle }

        .content {
            background: white;
            border-radius: 0 0 15px 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            height: 80vh;
            position: relative;
        }

        .tab-content {
            display: none;
            height: 100%;
            position: relative;
        }

        .tab-content.active {
            display: block;
        }

        .iframe-container {
            width: 100%;
            height: 100%;
            position: relative;
        }

        iframe {
            width: 100%;
            height: 100%;
            border: none;
            background: white;
        }

        .loading {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2rem;
            color: #666;
            background: white;
            z-index: 10;
        }

        .loading::after {
            content: '';
            width: 30px;
            height: 30px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            margin-left: 10px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .expired-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            color: white;
            z-index: 1000;
        }

        .expired-message {
            text-align: center;
            padding: 40px;
            background: rgba(255,255,255,0.1);
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }

        .expired-message h2 {
            font-size: 2rem;
            margin-bottom: 15px;
            color: #ff6b6b;
        }

        .expired-message p {
            font-size: 1.1rem;
            line-height: 1.6;
        }

        .permission-notice {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.8rem;
            z-index: 100;
            display: none;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .tab {
                font-size: 1rem;
                padding: 12px 15px;
            }
        /* Registration overlay styles (integrated from index.html) */
        .overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.55);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
        }
        .form-card {
            width: 100%;
            max-width: 680px;
            background: #fff;
            padding: 22px;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.25);
            color: #111;
        }
        .form-card h2 { margin: 0 0 8px 0; font-size:18px }
        .form-row { margin-top:12px }
        .form-row label { display:block; font-size:13px; color:#333 }
        .form-row input, .form-row select { width:100%; padding:10px 12px; margin-top:6px; border-radius:8px; border:1px solid #e3e7ea; font-size:14px; box-sizing:border-box }
        .form-actions { margin-top:18px; display:flex; gap:10px; align-items:center }
        .msg { margin-top:12px; padding:10px; border-radius:8px; font-size:14px }
        .msg.error { background:#fff0f0; color:#900; border:1px solid #fcc }
        .msg.success { background:#f0fff6; color:#0a6b2f; border:1px solid #cfeed8 }
        .spinner { display:inline-block; width:16px; height:16px; border-radius:50%; border:2px solid rgba(0,0,0,0.12); border-top-color:#fff; animation:spin 1s linear infinite; margin-left:8px; vertical-align:middle }
            
            .content {
                height: 70vh;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">

        <!-- Registration overlay: user must register before trying -->
        <div id="registrationOverlay" class="overlay" aria-hidden="false">
            <div class="form-card" role="dialog" aria-modal="true">
                <h2>ç”³è«‹ 12 å°æ™‚ è©¦ç”¨</h2>
                <p class="small" style="color:#666; margin-top:6px">è«‹å…ˆå¡«å¯«è¯çµ¡è³‡è¨Šï¼Œæˆ‘å€‘æœƒç«‹å³ç‚ºæ‚¨é–‹é€š 12 å°æ™‚è©¦ç”¨ï¼ˆåŒ email / é›»è©±å°‡ä¸é‡è¤‡è©¦ç”¨ï¼‰ã€‚</p>

                <form id="trialForm" autocomplete="on">
                    <div class="form-row">
                        <label for="parentName" class="required">å®¶é•·å§“å</label>
                        <input id="parentName" name="parentName" type="text" required placeholder="ä¾‹å¦‚ï¼šç‹å°æ˜" />
                    </div>

                    <div class="form-row">
                        <label for="contactPhone" class="required">è¯çµ¡é›»è©±</label>
                        <input id="contactPhone" name="contactPhone" type="tel" required placeholder="ä¾‹å¦‚ï¼š0912-345-678" />
                    </div>

                    <div class="form-row">
                        <label for="email" class="required">Email</label>
                        <input id="email" name="email" type="email" required placeholder="example@mail.com" />
                    </div>

                    <div class="form-row">
                        <label for="childAge" class="required">å­©ç«¥å¹´é½¡</label>
                        <select id="childAge" name="childAge" required>
                            <option value="">-- è«‹é¸æ“‡ --</option>
                            <option value="3">3 æ­²</option>
                            <option value="4">4 æ­²</option>
                            <option value="5">5 æ­²</option>
                            <option value="6">6 æ­²</option>
                            <option value="7">7 æ­²</option>
                            <option value="8">8 æ­²</option>
                            <option value="9">9 æ­²</option>
                            <option value="10">10 æ­²</option>
                            <option value="11">11 æ­²</option>
                            <option value="12">12 æ­²</option>
                            <option value="13">13 æ­²</option>
                            <option value="14">14 æ­²</option>
                            <option value="15">15 æ­²</option>
                            <option value="16">16 æ­²</option>
                            <option value="17">17 æ­²</option>
                            <option value="18">18 æ­²</option>
                        </select>
                    </div>

                    <div class="small" style="margin-top:8px;color:#666">æˆ‘å€‘åªæœƒç”¨ä¾†è™•ç†è©¦ç”¨èˆ‡è¯çµ¡ï¼Œéå…¬é–‹åˆ†äº«ã€‚</div>

                    <div class="form-actions">
                        <button id="submitBtn" type="submit" style="background:#1767e3; color:#fff; border-radius:10px; padding:10px 14px; border:0; font-weight:600; cursor:pointer">ç«‹å³ç”³è«‹è©¦ç”¨</button>
                        <div id="feedback" aria-live="polite"></div>
                    </div>
                </form>
            </div>
        </div>

            <h1>ğŸ¯ è‹±èªå­¸ç¿’å¹³å°</h1>
            <div class="timer-display" id="timerDisplay">
                â° å‰©é¤˜æ™‚é–“: <span id="timeLeft">12:00:00</span>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" data-tab="adventure" onclick="switchTab('adventure')">
                ğŸï¸ è‹±èªå†’éšªå³¶
            </button>
            <button class="tab" data-tab="companion" onclick="switchTab('companion')">
                ğŸ¤– AIè‹±èªä¼´è®€
            </button>
        </div>

        <div class="content">
            <div id="adventure" class="tab-content active">
                <div class="iframe-container">
                    <div class="loading" id="adventureLoading">æ­£åœ¨è¼‰å…¥è‹±èªå†’éšªå³¶...</div>
                    <div class="permission-notice" id="adventurePermission">
                        ğŸ¤ å·²è«‹æ±‚éº¥å…‹é¢¨æ¬Šé™
                    </div>
                    <iframe 
                        id="adventureFrame"
                        src=""
                        allow="microphone *; camera *; autoplay *; encrypted-media *; fullscreen *; geolocation *; accelerometer *; gyroscope *; magnetometer *; payment *; usb *"
                        allowfullscreen
                        sandbox="allow-same-origin allow-scripts allow-popups allow-forms allow-modals allow-storage-access-by-user-activation allow-top-navigation-by-user-activation"
                        referrerpolicy="no-referrer-when-downgrade"
                        loading="lazy">
                    </iframe>
                </div>
            </div>

            <div id="companion" class="tab-content">
                <div class="iframe-container">
                    <div class="loading" id="companionLoading">æ­£åœ¨è¼‰å…¥AIè‹±èªä¼´è®€...</div>
                    <div class="permission-notice" id="companionPermission">
                        ğŸ¤ å·²è«‹æ±‚éº¥å…‹é¢¨æ¬Šé™
                    </div>
                    <iframe 
                        id="companionFrame"
                        src=""
                        allow="microphone *; camera *; autoplay *; encrypted-media *; fullscreen *; geolocation *; accelerometer *; gyroscope *; magnetometer *; payment *; usb *"
                        allowfullscreen
                        sandbox="allow-same-origin allow-scripts allow-popups allow-forms allow-modals allow-storage-access-by-user-activation allow-top-navigation-by-user-activation"
                        referrerpolicy="no-referrer-when-downgrade"
                        loading="lazy">
                    </iframe>
                </div>
            </div>

            <div class="expired-overlay" id="expiredOverlay">
                <div class="expired-message">
                    <h2>â° è©¦ç”¨æ™‚é–“å·²çµæŸ</h2>
                    <p>æ‚¨çš„12å°æ™‚è©¦ç”¨æœŸå·²åˆ°æœŸ<br>
                    æ„Ÿè¬æ‚¨é«”é©—æˆ‘å€‘çš„è‹±èªå­¸ç¿’å¹³å°ï¼<br>
                    å¦‚éœ€ç¹¼çºŒä½¿ç”¨ï¼Œè«‹è¯ç¹«å®¢æœã€‚</p>
                </div>
            </div>
        </div>
    </div>

    <!-- LINE å®˜æ–¹åŠ å…¥å€å¡Šï¼ˆä¸å½±éŸ¿ iframe èˆ‡è¡¨å–®ï¼‰ -->
    <section aria-label="åŠ å…¥LINEå®¢æœ" style="padding:18px 0;">
        <div class="container" style="text-align:center;">
            <div style="margin-top:32px; text-align:center;">
                <div style="font-size:1.1em; margin-bottom:10px; color: #fff">åŠ å…¥LINEå®˜æ–¹ï¼Œç²å¾—ä¸€å°ä¸€è«®è©¢ï¼š</div>
                <img src="https://qr-official.line.me/gs/M_416ooiuy_GW.png?oat_content=qr" alt="åŠ å…¥LINEå®˜æ–¹QRç¢¼" style="width:160px; height:160px; margin-bottom:10px; display:block; margin-left:auto; margin-right:auto;" />
                <br>
                <a href="https://lin.ee/CgjbjsH" target="_blank" rel="noopener noreferrer"><img src="https://scdn.line-apps.com/n/line_add_friends/btn/zh-Hant.png" alt="åŠ å…¥å¥½å‹" height="36" border="0" style="display:inline-block;"></a>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer" style="padding:14px 0; background: linear-gradient(180deg, rgba(0,0,0,0.0), rgba(0,0,0,0.08));">
        <div class="container" style="text-align:center; color: #fff;">
            <p>&copy; 2025 AIè‹±èªä¼´è®€ - æ„›ç±³è‹±èªå†’éšªå³¶. è®“æ¯å€‹å­©å­éƒ½èƒ½å¿«æ¨‚å­¸è‹±æ–‡</p>
            <p>å®¢æœå°ˆç·šï¼š0800287643/02-25490058 | LINEå®¢æœï¼š@416ooiuy | æœå‹™æ™‚é–“ï¼šé€±ä¸€è‡³é€±äº”ä¸Šåˆ9:00-ä¸‹åˆ18:00</p>
        </div>
    </footer>

    <script>
        /***************** é‡è¦ï¼šæŠŠé€™è£¡æ”¹æˆä½ éƒ¨ç½²çš„ Apps Script Web App URL *****************/
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwlaIs-liXkaW_2LisidPhPg9oJjY_i8_uZ24SNsAb2aoRLymb2584MTbs36OygTmHO9g/exec';
        /***************************************************************************************/

        // Helper: POST application/x-www-form-urlencoded and parse JSON
        async function postFormUrlencoded(url, payloadObj) {
            const body = new URLSearchParams();
            for (const k in payloadObj) body.append(k, payloadObj[k]);
            const resp = await fetch(url, { method: 'POST', body: body });
            const txt = await resp.text();
            try { return JSON.parse(txt); } catch (e) { return { success: false, raw: txt }; }
        }

        // Small utils
        function showMessage(text, type) {
            const fb = document.getElementById('feedback');
            if (!fb) return;
            fb.innerHTML = '<div class="msg ' + (type || '') + '">' + text + '</div>';
        }
        function clearMessage() { const fb=document.getElementById('feedback'); if (fb) fb.innerHTML=''; }
        function sanitizePhone(phone) {
            phone = String(phone || '').trim();
            if (phone.startsWith('+')) return '+' + phone.slice(1).replace(/\D/g, '');
            return phone.replace(/\D/g, '');
        }
        function isValidEmail(email) { return /\S+@\S+\.\S+/.test(String(email || '').trim()); }
        function isValidPhone(phone) {
            if (!phone) return false;
            // allow leading +, then 8-15 digits total
            const cleaned = String(phone).trim();
            const m = cleaned.match(/^\+?(\d{8,15})$/);
            return !!m;
        }

        // Registration form handling (overlay)
        const form = document.getElementById('trialForm');
        const submitBtn = document.getElementById('submitBtn');
        const overlay = document.getElementById('registrationOverlay');

        async function handleRegistrationSubmit(ev) {
            ev.preventDefault();
            clearMessage();

            const parentName = document.getElementById('parentName').value.trim();
            const contactPhoneRaw = document.getElementById('contactPhone').value.trim();
            const emailRaw = document.getElementById('email').value.trim();
            const childAge = document.getElementById('childAge').value;

            if (!parentName) { showMessage('è«‹å¡«å¯«å®¶é•·å§“å', 'error'); return; }
            if (!contactPhoneRaw) { showMessage('è«‹å¡«å¯«è¯çµ¡é›»è©±', 'error'); return; }
            const contactPhone = sanitizePhone(contactPhoneRaw);
            if (!isValidPhone(contactPhone)) { showMessage('è«‹è¼¸å…¥æ­£ç¢ºçš„é›»è©±ï¼Œéœ€ 8â€“15 ä½æ•¸å­—ï¼Œå¯å« + é–‹é ­', 'error'); return; }
            if (!isValidEmail(emailRaw)) { showMessage('è«‹è¼¸å…¥æ­£ç¢ºçš„ Email', 'error'); return; }
            if (!childAge) { showMessage('è«‹é¸æ“‡å­©ç«¥å¹´é½¡', 'error'); return; }

            if (!APPS_SCRIPT_URL || APPS_SCRIPT_URL.includes('PUT_YOUR_APPS_SCRIPT')) {
                showMessage('è«‹å…ˆå°‡ APPS_SCRIPT_URL å¡«å…¥ç¨‹å¼é ‚ç«¯ï¼Œå¦å‰‡ç„¡æ³•é€å‡ºã€‚', 'error');
                return;
            }

            // lock
            submitBtn.disabled = true; const spinner = document.createElement('span'); spinner.className='spinner'; submitBtn.appendChild(spinner);

            try {
                const checkPayload = { action: 'checkUser', email: emailRaw, phone: contactPhone };
                const checkResp = await postFormUrlencoded(APPS_SCRIPT_URL, checkPayload);
                if (!checkResp || !checkResp.success) {
                    const errMsg = (checkResp && checkResp.error) ? checkResp.error : 'æª¢æŸ¥ä½¿ç”¨è€…æ™‚ç™¼ç”ŸéŒ¯èª¤';
                    showMessage('é©—è­‰å¤±æ•—ï¼š' + errMsg, 'error');
                    return;
                }
                if (checkResp.userExists && checkResp.activeTrial) {
                    const until = checkResp.trialEndTime ? new Date(checkResp.trialEndTime).toLocaleString() : 'å°šæœªæŒ‡å®š';
                    showMessage('æ­¤ Email æˆ–é›»è©±å·²æ“æœ‰æœ‰æ•ˆè©¦ç”¨ï¼ˆåˆ° ' + until + 'ï¼‰ã€‚è‹¥æœ‰å•é¡Œè«‹è¯çµ¡å®¢æœã€‚', 'error');
                    return;
                }

                // add row
                const registrationTime = new Date().toISOString();
                const trialEnd = new Date(Date.now() + 12 * 60 * 60 * 1000).toISOString();
                const dataObj = {
                    parentName: parentName,
                    contactPhone: contactPhone,
                    email: emailRaw.toLowerCase(),
                    childAge: childAge || '',
                    registrationTime: registrationTime,
                    trialEndTime: trialEnd,
                    location: { origin: location.origin || '', pathname: location.pathname || '' }
                };
                const addPayload = { action: 'addRow', data: JSON.stringify(dataObj) };
                const addResp = await postFormUrlencoded(APPS_SCRIPT_URL, addPayload);
                if (!addResp || !addResp.success) {
                    const err = (addResp && addResp.error) ? addResp.error : (addResp && addResp.raw ? addResp.raw : 'æ–°å¢å¤±æ•—');
                    showMessage('è¨»å†Šå¤±æ•—ï¼š' + err, 'error');
                    return;
                }

                // success: persist a registration token locally and start trial
                localStorage.setItem('englishLearningTrialRegistered', JSON.stringify({ email: emailRaw.toLowerCase(), startedAt: Date.now(), trialEnd }));
                showMessage('å·²æˆåŠŸé–‹é€š 12 å°æ™‚è©¦ç”¨ï¼æ­£åœ¨å•Ÿå‹•å¹³å°â€¦', 'success');
                setTimeout(() => {
                    overlay.style.display = 'none';
                    // initialize or resume TrialManager
                    if (!trialManager) {
                        trialManager = new TrialManager();
                    } else {
                        trialManager.onRegistered();
                    }
                }, 800);

            } catch (err) {
                console.error(err);
                showMessage('ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚(' + (err.message || err) + ')', 'error');
            } finally {
                submitBtn.disabled = false; const sp = submitBtn.querySelector('.spinner'); if (sp) sp.remove();
            }
        }
        form.addEventListener('submit', handleRegistrationSubmit);

        // é˜²æ­¢ç”¨æˆ¶å¦å­˜/è¤‡è£½/æª¢è¦–åŸå§‹ç¢¼ç­‰ç°¡å–®å®¢æˆ¶ç«¯è¡Œç‚ºï¼ˆåƒ…ä½œå‰ç«¯é˜»æ“‹ï¼Œç„¡æ³•å®Œå…¨é˜²æ­¢ï¼‰
        function installAntiCopyHandlers() {
            // ç¦ç”¨å³éµé¸å–®
            document.addEventListener('contextmenu', (e) => { e.preventDefault(); });
            // ç¦ç”¨è¤‡è£½/å‰ªä¸‹/è²¼ä¸Š
            document.addEventListener('copy', (e) => { e.preventDefault(); });
            document.addEventListener('cut', (e) => { e.preventDefault(); });
            // ç¦ç”¨æ–‡å­—é¸å–ï¼ˆä½†å…è¨±è¡¨å–®å…§é¸å–ï¼‰
            document.body.style.userSelect = 'none';
            const formCard = document.querySelector('.form-card');
            if (formCard) formCard.style.userSelect = 'text';
            // å–æ¶ˆæ‹–æ›³
            document.addEventListener('dragstart', (e) => { e.preventDefault(); });

            // æ””æˆªå¸¸è¦‹å¿«æ·éµï¼šCtrl+S, Ctrl+U, Ctrl+Shift+I/J/C, F12
            document.addEventListener('keydown', (e) => {
                const key = e.key.toLowerCase();
                const ctrl = e.ctrlKey || e.metaKey;
                if ((ctrl && key === 's') || (ctrl && key === 'u') || e.key === 'F12' || (ctrl && e.shiftKey && (key === 'i' || key === 'j' || key === 'c'))) {
                    e.preventDefault();
                    e.stopPropagation();
                    // å¯é¡¯ç¤ºæç¤º
                    const fb = document.getElementById('feedback');
                    if (fb && fb.innerHTML === '') fb.innerHTML = '<div class="msg small">æ­¤é å…§å®¹å—ä¿è­·ï¼Œè«‹é€éå¹³å°æ“ä½œã€‚</div>';
                    return false;
                }
            }, { capture: true });
        }
        installAntiCopyHandlers();

        class TrialManager {
            constructor() {
                this.TRIAL_DURATION = 12 * 60 * 60 * 1000; // 12å°æ™‚æ¯«ç§’
                this.STORAGE_KEY = 'englishLearningTrialStart';
                this.PERMISSION_STORAGE_KEY = 'englishLearningPermissions';
                this.currentTab = 'adventure';
                this.isExpired = false;
                this.loadedTabs = new Set();
                this.permissionsGranted = false;
                
                this.init();
            }

            init() {
                this.checkTrialStatus();
                if (!this.isExpired) {
                    this.startTimer();
                    this.setupPermissions();
                    this.loadInitialTab();
                }
            }

            async setupPermissions() {
                try {
                    // æª¢æŸ¥å·²å­˜å„²çš„æ¬Šé™ç‹€æ…‹
                    const storedPermissions = JSON.parse(localStorage.getItem(this.PERMISSION_STORAGE_KEY) || '{}');
                    
                    // è«‹æ±‚éº¥å…‹é¢¨æ¬Šé™
                    if (!storedPermissions.microphone) {
                        try {
                            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                            stream.getTracks().forEach(track => track.stop());
                            storedPermissions.microphone = true;
                            this.showPermissionNotice('ğŸ¤ éº¥å…‹é¢¨æ¬Šé™å·²æˆæ¬Š');
                        } catch (e) {
                            console.log('éº¥å…‹é¢¨æ¬Šé™è«‹æ±‚è¢«æ‹’çµ•:', e);
                            storedPermissions.microphone = false;
                        }
                    }

                    // è«‹æ±‚ç›¸æ©Ÿæ¬Šé™ï¼ˆå¦‚æœéœ€è¦ï¼‰
                    if (!storedPermissions.camera) {
                        try {
                            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                            stream.getTracks().forEach(track => track.stop());
                            storedPermissions.camera = true;
                        } catch (e) {
                            console.log('ç›¸æ©Ÿæ¬Šé™è«‹æ±‚è¢«æ‹’çµ•:', e);
                            storedPermissions.camera = false;
                        }
                    }

                    // ä¿å­˜æ¬Šé™ç‹€æ…‹
                    localStorage.setItem(this.PERMISSION_STORAGE_KEY, JSON.stringify(storedPermissions));
                    this.permissionsGranted = storedPermissions.microphone;

                } catch (error) {
                    console.log('æ¬Šé™è¨­ç½®å¤±æ•—:', error);
                }
            }

            showPermissionNotice(message) {
                const notices = document.querySelectorAll('.permission-notice');
                notices.forEach(notice => {
                    notice.textContent = message;
                    notice.style.display = 'block';
                    setTimeout(() => {
                        notice.style.display = 'none';
                    }, 3000);
                });
            }

                // ...existing code...
            checkTrialStatus() {
                let trialStart = localStorage.getItem(this.STORAGE_KEY);
                
                if (!trialStart) {
                    // é¦–æ¬¡ä½¿ç”¨ï¼Œè¨˜éŒ„é–‹å§‹æ™‚é–“
                    trialStart = Date.now();
                    localStorage.setItem(this.STORAGE_KEY, trialStart.toString());
                } else {
                    trialStart = parseInt(trialStart);
                }

                const elapsed = Date.now() - trialStart;
                
                if (elapsed >= this.TRIAL_DURATION) {
                    this.showExpiredMessage();
                    this.isExpired = true;
                } else {
                    this.remainingTime = this.TRIAL_DURATION - elapsed;
                }
            }

            startTimer() {
                this.updateTimerDisplay();
                
                this.timerInterval = setInterval(() => {
                    this.remainingTime -= 1000;
                    
                    if (this.remainingTime <= 0) {
                        this.showExpiredMessage();
                        clearInterval(this.timerInterval);
                        return;
                    }
                    
                    this.updateTimerDisplay();
                }, 1000);
            }

            updateTimerDisplay() {
                const hours = Math.floor(this.remainingTime / (60 * 60 * 1000));
                const minutes = Math.floor((this.remainingTime % (60 * 60 * 1000)) / (60 * 1000));
                const seconds = Math.floor((this.remainingTime % (60 * 1000)) / 1000);
                
                const timeString = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                document.getElementById('timeLeft').textContent = timeString;
            }

            showExpiredMessage() {
                document.getElementById('expiredOverlay').style.display = 'flex';
                this.isExpired = true;
                
                // æ¸…ç†æ‰€æœ‰iframe
                const frames = document.querySelectorAll('iframe');
                frames.forEach(frame => {
                    frame.src = 'about:blank';
                });
            }

            loadInitialTab() {
                // é è¼‰å…¥è‹±èªå†’éšªå³¶
                setTimeout(() => {
                    this.loadTabContent('adventure');
                }, 500);
            }

            loadTabContent(tabName) {
                if (this.isExpired || this.loadedTabs.has(tabName)) return;

                const loadingElement = document.getElementById(tabName + 'Loading');
                const iframe = document.getElementById(tabName + 'Frame');
                
                // æ ¹æ“šä¸åŒtabè¼‰å…¥ä¸åŒURL
                const urls = {
                    'adventure': 'https://afs-english-adventure.web.app/',
                    'companion': 'https://ai-english-pet-fcc1c.firebaseapp.com/'
                };
                
                // è¨­ç½®iframeå±¬æ€§ä»¥ç¢ºä¿å®Œæ•´åŠŸèƒ½
                iframe.src = urls[tabName];
                
                const loadTimeout = setTimeout(() => {
                    if (loadingElement.style.display !== 'none') {
                        loadingElement.innerHTML = 'âš ï¸ è¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™...';
                    }
                }, 5000);

                iframe.onload = () => {
                    clearTimeout(loadTimeout);
                    loadingElement.style.display = 'none';
                    this.loadedTabs.add(tabName);
                    
                    // ç¢ºä¿iframeå¯è¦‹
                    iframe.style.display = 'block';
                    iframe.style.visibility = 'visible';
                    
                    console.log(`${tabName} è¼‰å…¥å®Œæˆ`);
                };
                
                iframe.onerror = () => {
                    clearTimeout(loadTimeout);
                    loadingElement.innerHTML = 'âŒ è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š';
                    console.error(`${tabName} è¼‰å…¥å¤±æ•—`);
                };

                // è™•ç†iframeå…§éƒ¨å°èˆª
                iframe.addEventListener('load', () => {
                    try {
                        // å˜—è©¦èˆ‡iframeé€šä¿¡ä»¥ç¢ºä¿æ¬Šé™æ­£ç¢ºå‚³é
                        iframe.contentWindow.postMessage({
                            type: 'PARENT_READY',
                            permissions: JSON.parse(localStorage.getItem(this.PERMISSION_STORAGE_KEY) || '{}')
                        }, '*');
                    } catch (e) {
                        console.log('iframeé€šä¿¡è¨­ç½®:', e);
                    }
                });
            }

            switchTab(newTab) {
                if (this.isExpired) return;
                
                // ç§»é™¤æ‰€æœ‰active class
                document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                
                // æ·»åŠ active classåˆ°æ–°tab
                // å°‹æ‰¾å°æ‡‰çš„ tab buttonï¼ˆè‹¥æœ‰ event å‰‡ä½¿ç”¨ event.targetï¼‰
                const activeBtn = document.querySelector('.tab[data-tab="' + newTab + '"]') || null;
                if (activeBtn) activeBtn.classList.add('active');
                document.getElementById(newTab).classList.add('active');
                
                // ç®¡ç†iframeçš„å¯è¦‹æ€§ä»¥é¿å…è¡çª
                const allFrames = document.querySelectorAll('iframe');
                allFrames.forEach(frame => {
                    if (frame.id === newTab + 'Frame') {
                        frame.style.visibility = 'visible';
                        frame.style.display = 'block';
                    } else {
                        frame.style.visibility = 'hidden';
                    }
                });
                
                this.currentTab = newTab;
                
                // è¼‰å…¥tabå…§å®¹ï¼ˆå¦‚æœå°šæœªè¼‰å…¥ï¼‰
                if (!this.loadedTabs.has(newTab)) {
                    this.loadTabContent(newTab);
                }
            }

            // Called after successful registration overlay
            onRegistered() {
                // Ensure trial start recorded
                const saved = localStorage.getItem(this.STORAGE_KEY);
                if (!saved) {
                    localStorage.setItem(this.STORAGE_KEY, Date.now().toString());
                }
                // re-run init flow (start timer and load)
                this.isExpired = false;
                this.checkTrialStatus();
                if (!this.isExpired) {
                    if (this.timerInterval) clearInterval(this.timerInterval);
                    this.startTimer();
                    this.setupPermissions();
                    this.loadInitialTab();
                }
            }
        }

        // å…¨åŸŸå‡½æ•¸ä¾›HTMLèª¿ç”¨
        let trialManager;

        function switchTab(tabName) {
            trialManager.switchTab(tabName);
        }

        // ç›£è½ä¾†è‡ªiframeçš„æ¶ˆæ¯
        window.addEventListener('message', (event) => {
            // è™•ç†ä¾†è‡ªåµŒå…¥ç¶²ç«™çš„æ¬Šé™è«‹æ±‚
            if (event.data && event.data.type === 'REQUEST_PERMISSIONS') {
                console.log('æ”¶åˆ°æ¬Šé™è«‹æ±‚:', event.data);
            }
        });

        // é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–ï¼šåƒ…åœ¨å·²è¨»å†Šæƒ…æ³ä¸‹å•Ÿå‹• TrialManager
        document.addEventListener('DOMContentLoaded', () => {
            try {
                const reg = localStorage.getItem('englishLearningTrialRegistered');
                if (reg) {
                    // éš±è—è¨»å†Š overlay ä¸¦å•Ÿå‹• trial
                    const ov = document.getElementById('registrationOverlay');
                    if (ov) ov.style.display = 'none';
                    trialManager = new TrialManager();
                } else {
                    // ç¢ºä¿ overlay å¯è¦‹ï¼Œç­‰å¾…ä½¿ç”¨è€…è¨»å†Š
                    const ov = document.getElementById('registrationOverlay');
                    if (ov) ov.style.display = 'flex';
                }
            } catch (e) {
                console.error('åˆå§‹åŒ–æ™‚æª¢æŸ¥è¨»å†Šç‹€æ…‹å¤±æ•—', e);
                // è‹¥ç™¼ç”ŸéŒ¯èª¤ï¼Œå®‰å…¨åœ°ä¸å•Ÿå‹• trial
            }
        });

        // é é¢é—œé–‰å‰æ¸…ç†
        window.addEventListener('beforeunload', () => {
            if (trialManager && trialManager.timerInterval) {
                clearInterval(trialManager.timerInterval);
            }
        });

        // è™•ç†é é¢å¯è¦‹æ€§è®ŠåŒ–ï¼Œæš«åœä¸å¯è¦‹çš„iframeä»¥ç¯€çœè³‡æº
        document.addEventListener('visibilitychange', () => {
            if (trialManager && !trialManager.isExpired) {
                const currentFrame = document.getElementById(trialManager.currentTab + 'Frame');
                if (document.hidden) {
                    // é é¢éš±è—æ™‚ï¼Œæš«åœç•¶å‰iframe
                    if (currentFrame) {
                        currentFrame.style.visibility = 'hidden';
                    }
                } else {
                    // é é¢å¯è¦‹æ™‚ï¼Œæ¢å¾©ç•¶å‰iframe
                    if (currentFrame) {
                        currentFrame.style.visibility = 'visible';
                    }
                }
            }
        });
    </script>
</body>
</html>